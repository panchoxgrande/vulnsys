<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Vulnerabilidades</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Light Theme (Default) */
        body {
            background-color: #f8f9fa;
            color: #212529;
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .table {
            background-color: #fff;
        }

        /* Dark Theme */
        body.dark-theme {
            background-color: #212529;
            color: #f8f9fa;
        }
        .dark-theme .card {
            background-color: #343a40;
            color: #f8f9fa;
            border-color: #495057;
        }
        .dark-theme .table, .dark-theme .table th, .dark-theme .table td {
            background-color: #343a40;
            color: #f8f9fa;
        }
        .dark-theme .table-hover tbody tr:hover {
            background-color: #495057;
        }
        .dark-theme .list-group-item {
            background-color: #343a40;
            border-color: #495057;
        }
        .dark-theme .form-label, .dark-theme .lead, .dark-theme .text-muted {
            color: #f8f9fa !important;
        }
        .dark-theme .dropdown-menu {
            background-color: #343a40;
        }
        .dark-theme .dropdown-item {
            color: #f8f9fa;
        }
        .dark-theme .dropdown-item:hover {
            background-color: #495057;
        }

        /* Hacker Theme */
        body.hacker-theme {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
        }
        .hacker-theme .card, .hacker-theme .card-header, .hacker-theme .card-body {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
            box-shadow: 0 0 10px #0f0;
        }
        .hacker-theme .table, .hacker-theme .table th, .hacker-theme .table td {
            background-color: #000;
            color: #0f0;
            border: 1px solid #0f0;
        }
        .hacker-theme .table-hover tbody tr:hover {
            background-color: #030;
        }
        .hacker-theme .list-group-item {
            background-color: #000;
            border-color: #0f0;
            color: #0f0;
        }
        .hacker-theme .btn-primary {
            background-color: #0f0;
            border-color: #0f0;
            color: #000;
        }
        .hacker-theme .btn-outline-primary {
            border-color: #0f0;
            color: #0f0;
        }
        .hacker-theme .btn-outline-primary:hover {
            background-color: #0f0;
            color: #000;
        }
        .hacker-theme .form-select {
            background-color: #000;
            color: #0f0;
            border-color: #0f0;
        }
        .hacker-theme .form-label, .hacker-theme .lead, .hacker-theme .text-muted, .hacker-theme h1, .hacker-theme h3, .hacker-theme h5 {
            color: #0f0 !important;
        }
        .hacker-theme .dropdown-menu {
            background-color: #000;
            border: 1px solid #0f0;
        }
        .hacker-theme .dropdown-item {
            color: #0f0;
        }
        .hacker-theme .dropdown-item:hover {
            background-color: #030;
        }

        #loading-cves { display: none; }
        .severity-CRITICAL { background-color: #dc3545; color: white; }
        .severity-HIGH { background-color: #fd7e14; color: white; }
        .severity-MEDIUM { background-color: #ffc107; color: black; }
        .severity-LOW { background-color: #0dcaf0; color: black; }
        .details { display: none; background-color: #e9ecef; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .asset-row:hover { cursor: pointer; background-color: #e9ecef; }
        .asset-row.table-active { background-color: #cce5ff; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="text-center flex-grow-1">
                <h1 class="display-5">Panel de Vulnerabilidades</h1>
                <p class="lead">Análisis de amenazas en tiempo real</p>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="theme-switcher" data-bs-toggle="dropdown" aria-expanded="false">
                    Tema
                </button>
                <ul class="dropdown-menu" aria-labelledby="theme-switcher">
                    <li><a class="dropdown-item" href="#" onclick="setTheme('light')">Claro</a></li>
                    <li><a class="dropdown-item" href="#" onclick="setTheme('dark')">Oscuro</a></li>
                    <li><a class="dropdown-item" href="#" onclick="setTheme('hacker')">Hacker</a></li>
                </ul>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h5 class="card-title mb-0">Equipos Monitoreados</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>Hostname</th><th>Sistema Operativo</th><th>Dirección IP</th><th>Cliente</th></tr></thead>
                        <tbody id="assets-table-body"><tr><td colspan="4" class="text-center">Cargando equipos...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Acciones Globales</h5>
                <a href="settings.html" class="btn btn-outline-secondary btn-sm position-absolute top-0 end-0 m-2">Ir a Configuración</a>
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <label class="form-label">1. Buscar nuevas vulnerabilidades (CVEs):</label>
                        <div id="time-filters" class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary" data-days="1">24 Horas</button>
                            <button type="button" class="btn btn-primary" data-days="7">7 Días</button>
                            <button type="button" class="btn btn-outline-primary" data-days="30">30 Días</button>
                            <button type="button" class="btn btn-outline-primary" data-days="60">60 Días</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">2. Analizar y correlacionar datos:</label>
                        <button id="correlateBtn" class="btn btn-success w-100">Correlacionar Vulnerabilidades</button>
                    </div>
                </div>
            </div>
        </div>

        <hr/>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 id="vuln-title">Vulnerabilidades</h3>
            <div id="result-filters" class="row g-2 w-50">
                <div class="col"><select id="filter-severity" class="form-select"><option value="all">Severidad (Todos)</option><option value="CRITICAL">Critical</option><option value="HIGH">High</option><option value="MEDIUM">Medium</option><option value="LOW">Low</option></select></div>
                <div class="col"><select id="filter-exploit" class="form-select"><option value="all">Exploit (Todos)</option><option value="true">Sí</option><option value="false">No</option></select></div>
                <div class="col"><select id="filter-pulses" class="form-select"><option value="all">Pulsos OTX (Todos)</option><option value="true">Con Pulsos</option><option value="false">Sin Pulsos</option></select></div>
            </div>
        </div>
        
        <div id="loading-cves" class="text-center mb-4" style="display: none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Cargando...</p>
        </div>
        <div id="stats" class="alert alert-light text-center border" style="display: none;"></div>
        <div id="cve-cards-container" class="row g-4">
            <p class="text-center text-muted">Selecciona un equipo de la tabla de arriba para ver sus vulnerabilidades.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = `http://${window.location.hostname}:5000`;

        const loadingSpinner = document.getElementById('loading-cves');
        const cardsContainer = document.getElementById('cve-cards-container');
        const statsDiv = document.getElementById('stats');
        const timeFilterButtons = document.querySelectorAll('#time-filters .btn');
        const resultFilters = document.querySelectorAll('#result-filters select');
        const assetsTableBody = document.getElementById('assets-table-body');
        const correlateBtn = document.getElementById('correlateBtn');
        const vulnTitle = document.getElementById('vuln-title');

        document.addEventListener('DOMContentLoaded', () => {
            fetchAssets();
            fetchAllCvesFromDB();
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        });

        function setTheme(theme) {
            document.body.className = theme + '-theme';
            localStorage.setItem('theme', theme);
        }

        correlateBtn.addEventListener('click', runCorrelation);
        resultFilters.forEach(filter => filter.addEventListener('change', applyFilters));
        timeFilterButtons.forEach(button => button.addEventListener('click', function() {
            timeFilterButtons.forEach(btn => btn.classList.replace('btn-primary', 'btn-outline-primary'));
            this.classList.replace('btn-outline-primary', 'btn-primary');
            fetchCVEs(this.getAttribute('data-days'));
        }));

        function fetchAssets() {
            fetch(`${API_BASE_URL}/api/assets`)
                .then(response => response.ok ? response.json() : Promise.reject('Error cargando activos'))
                .then(assets => {
                    assetsTableBody.innerHTML = '';
                    if (assets.length === 0) {
                        assetsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">Aún no se han reportado equipos.</td></tr>';
                    } else {
                        assets.forEach(asset => {
                            const row = document.createElement('tr');
                            row.className = 'asset-row';
                            row.dataset.assetId = asset.id;
                            row.dataset.hostname = asset.hostname;
                            row.innerHTML = `<td>${asset.hostname}</td><td>${asset.os_type}</td><td>${asset.ip}</td><td><span class="badge bg-danger">${asset.vulnerability_count}</span></td><td>${asset.client_name}</td>`;
                            row.addEventListener('click', () => {
                                document.querySelectorAll('.asset-row').forEach(r => r.classList.remove('table-active'));
                                row.classList.add('table-active');
                                fetchVulnerabilitiesForAsset(asset.id, asset.hostname);
                            });
                            assetsTableBody.appendChild(row);
                        });
                    }
                })
                .catch(err => { assetsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${err}</td></tr>`; });
        }

        function fetchVulnerabilitiesForAsset(assetId, hostname) {
            vulnTitle.textContent = `Vulnerabilidades para: ${hostname}`;
            loadingSpinner.style.display = 'block';
            cardsContainer.innerHTML = '';
            statsDiv.style.display = 'none';
            fetch(`${API_BASE_URL}/api/vulnerabilities?asset_id=${assetId}`)
                .then(response => response.ok ? response.json() : Promise.reject('Error cargando vulnerabilidades.'))
                .then(vulns => { renderCards(vulns); statsDiv.innerHTML = `Se encontraron <strong>${vulns.length}</strong> vulnerabilidades para este equipo.`; statsDiv.style.display = 'block'; })
                .catch(err => { cardsContainer.innerHTML = `<div class="alert alert-danger">${err}</div>`; })
                .finally(() => { loadingSpinner.style.display = 'none'; });
        }

        function fetchCVEs(days) {
            vulnTitle.textContent = 'Buscando Nuevos CVEs...';
            loadingSpinner.style.display = 'block';
            cardsContainer.innerHTML = '';
            statsDiv.style.display = 'none';
            fetch(`${API_BASE_URL}/api/update_cves?days=${days}`)
                .then(response => response.ok ? response.json() : Promise.reject(`Error: ${response.statusText}`))
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    statsDiv.innerHTML = `Análisis completado: <strong>${data.cves_fetched_from_nvd}</strong> CVEs obtenidos, <strong>${(data.new_cves_to_be_saved || []).length}</strong> nuevos procesados. Actualizando vista...`;
                    statsDiv.style.display = 'block';
                    fetchAllCvesFromDB(); 
                })
                .catch(error => { 
                    cardsContainer.innerHTML = `<div class="alert alert-danger">Error al buscar nuevos CVEs: ${error.message}</div>`; 
                    loadingSpinner.style.display = 'none';
                });
        }

        function runCorrelation() {
            vulnTitle.textContent = 'Vulnerabilidades';
            loadingSpinner.style.display = 'block';
            statsDiv.style.display = 'block';
            statsDiv.innerHTML = 'Iniciando proceso de correlación en el servidor...';
            fetch(`${API_BASE_URL}/api/correlate`, { method: 'POST' })
                .then(response => response.ok ? response.json() : Promise.reject('Error en la correlación'))
                .then(data => {
                    statsDiv.innerHTML = `Correlación finalizada! Se encontraron <strong>${data.new_vulnerabilities_found}</strong> nuevas vulnerabilidades.`;
                })
                .catch(err => { statsDiv.innerHTML = `<div class="alert alert-danger">${err}</div>`; })
                .finally(() => { loadingSpinner.style.display = 'none'; });
        }

        function fetchAllCvesFromDB() {
            vulnTitle.textContent = 'Todos los CVEs en la Base de Datos';
            loadingSpinner.style.display = 'block';
            cardsContainer.innerHTML = '';
            statsDiv.style.display = 'none';
            fetch(`${API_BASE_URL}/api/cves`)
                .then(response => response.ok ? response.json() : Promise.reject('Error cargando CVEs de la BD.'))
                .then(cves => { renderCards(cves); statsDiv.innerHTML = `Se encontraron <strong>${cves.length}</strong> CVEs en la base de datos.`; statsDiv.style.display = 'block'; })
                .catch(err => { cardsContainer.innerHTML = `<div class="alert alert-danger">${err}</div>`; })
                .finally(() => { loadingSpinner.style.display = 'none'; });
        }
        
        function renderCards(items) {
            cardsContainer.innerHTML = '';
            if (items.length === 0) {
                cardsContainer.innerHTML = '<p class="text-center">No se encontraron vulnerabilidades.</p>';
                return;
            }
            items.forEach((item, index) => {
                const cardWrapper = document.createElement('div');
                cardWrapper.className = 'col-md-6 col-lg-4 cve-card-wrapper';
                const severityClass = `severity-${item.severity || 'N/A'}`;
                const detailId = `detail-${index}`;
                cardWrapper.dataset.severity = item.severity || 'N/A';
                cardWrapper.dataset.exploit = item.exploit_available;
                cardWrapper.dataset.pulses = (item.otx_pulses || 0) > 0;
                cardWrapper.innerHTML = `
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong class="text-primary">${item.cve_id}</strong>
                            <span class="badge ${severityClass}">${item.severity || 'N/A'}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${item.simplified_description}</p>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><strong>CVSS:</strong> ${item.cvss_score || 'N/A'}</li>
                                <li class="list-group-item"><strong>Risk Score:</strong> ${item.risk_score ? parseFloat(item.risk_score).toFixed(2) : 'N/A'}</li>
                                <li class="list-group-item"><strong>Exploit:</strong> ${item.exploit_available ? 'Sí' : 'No'}</li>
                            </ul>
                            <button class="btn btn-secondary btn-sm mt-3" onclick="toggleDetails('${detailId}')">Ver detalle técnico</button>
                            <div id="${detailId}" class="details"><small>${item.description_en}</small></div>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(cardWrapper);
            });
            applyFilters();
        }

        function applyFilters() {
            const severityFilter = document.getElementById('filter-severity').value;
            const exploitFilter = document.getElementById('filter-exploit').value;
            const pulsesFilter = document.getElementById('filter-pulses').value;
            const cards = document.querySelectorAll('.cve-card-wrapper');
            cards.forEach(card => {
                const cardSeverity = card.dataset.severity;
                const cardExploit = card.dataset.exploit;
                const cardPulses = card.dataset.pulses;
                const severityMatch = severityFilter === 'all' || cardSeverity === severityFilter;
                const exploitMatch = exploitFilter === 'all' || cardExploit === exploitFilter;
                const pulsesMatch = pulsesFilter === 'all' || cardPulses === pulsesFilter;
                if (severityMatch && exploitMatch && pulsesMatch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function toggleDetails(id) {
            const detailElement = document.getElementById(id);
            detailElement.style.display = detailElement.style.display === 'block' ? 'none' : 'block';
        }
    </script>
</body>
</html>